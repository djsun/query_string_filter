grammar Filter

  rule match
    and_expression / simple
  end
  
  rule and_expression
    simple ospace 'and' ospace match
    {
      def eval(env={})
        simple.eval.merge(match.eval(env))
      end
    }
  end
  
  rule simple
    fuzzy / equality / inequality
  end

  rule fuzzy
    key ospace ':' ospace strings
    {
      def eval(env={})
        { key.eval => /#{strings.eval(env)}/ }
      end
    }
  end

  rule equality
    key ospace '=' ospace value
    {
      def eval(env={})
        { key.eval => value.eval(env) }
      end
    }
  end

  rule inequality
    gt / gte / lt / lte
  end
  
  rule gt
    key ospace '>' ospace value
    {
      def eval(env={})
        { key.eval => { '$gt' => value.eval(env) } }
      end
    }
  end
  
  rule gte
    key ospace '>=' ospace value
    {
      def eval(env={})
        { key.eval(env) => { '$gte' => value.eval(env) } }
      end
    }
  end
  
  rule lt
    key ospace '<' ospace value
    {
      def eval(env={})
        { key.eval(env) => { '$lt' => value.eval(env) } }
      end
    }
  end
  
  rule lte
    key ospace '<=' ospace value
    {
      def eval(env={})
        { key.eval(env) => { '$lte' => value.eval(env) } }
      end
    }
  end
  
  rule key
    [a-z_\.]+
    {
      def eval(env={})
        text_value
      end
    }
  end
  
  rule value
    integer / boolean / string
  end
  
  rule strings
    string more:(ospace ',' ospace string)*
    {
      def eval(env={})
        strings.map { |e| e.eval(env) }.join("|")
      end
      
      def strings
        [string] + more.elements.map { |e| e.string }
      end
    }
  end
  
  rule boolean
    boolean_true / boolean_false
  end

  rule boolean_true
    'true'
    {
      def eval(env={})
        true
      end
    }
  end
  
  rule boolean_false
    'false'
    {
      def eval(env={})
        false
      end
    }
  end
  
  rule string
    double_quoted_string / single_quoted_string / unquoted_string
  end

  rule double_quoted_string
    '"' (!'"' .)* '"'
    {
      def eval(env={})
        text_value[1 ... -1]
      end
    }
  end

  rule single_quoted_string
    '\'' (!'\'' .)* '\''
    {
      def eval(env={})
        text_value[1 ... -1]
      end
    }
  end
  
  rule unquoted_string
    [^<>=, ]+
    {
      def eval(env={})
        text_value
      end
    }
  end

  rule integer
    [0-9]+
    {
      def eval(env={})
        text_value.to_i
      end
    }
  end
  
  rule ospace
    ' '*
  end
  
  rule space
    ' '+
  end

end
